# Mellanox CX6dx vdpa offload

https://docs.mellanox.com/display/MLNXENv541030

https://docs.mellanox.com/display/MLNXOFEDv53100143/Introduction

![](imgs/2021-10-19-13-44-25.png)

![](imgs/2021-10-19-16-39-09.png)

![](imgs/2021-10-19-17-05-58.png)

![](imgs/2021-10-20-13-49-59.png)

![](imgs/2021-10-20-16-05-41.png)

有一个很麻烦的vf representor的概念，dpdk文档有说，简单里面，是给控制面准备的vf的分身。
- https://doc.dpdk.org/guides-18.11/prog_guide/switch_representation.html
```
   .-------------.                 .-------------. .-------------.
   | hypervisor  |                 |    VM 1     | |    VM 2     |
   | application |                 | application | | application |
   `--+---+---+--'                 `----------+--' `--+----------'
      |   |   |                               |       |
      |   |   `-------------------.           |       |
      |   `---------.             |           |       |
      |             |             |           |       |
.-----+-----. .-----+-----. .-----+-----.     |       |
| port_id 3 | | port_id 4 | | port_id 5 |     |       |
`-----+-----' `-----+-----' `-----+-----'     |       |
      |             |             |           |       |
    .-+--.    .-----+-----. .-----+-----. .---+--. .--+---.
    | PF |    | VF 1 rep. | | VF 2 rep. | | VF 1 | | VF 2 |
    `-+--'    `-----+-----' `-----+-----' `---+--' `--+---'
      |             |             |           |       |
      |             |   .---------'           |       |
      `-----.       |   |   .-----------------'       |
            |       |   |   |   .---------------------'
            |       |   |   |   |
         .--+-------+---+---+---+--.
         | managed interconnection |
         `------------+------------'
                      |
                 .----+-----.
                 | physical |
                 |  port 0  |
                 `----------'
```
# 103
## ovs offload
```bash

# on 103
lspci | grep -i mella
# 04:00.0 Ethernet controller: Mellanox Technologies MT2892 Family [ConnectX-6 Dx]
# 04:00.1 Ethernet controller: Mellanox Technologies MT2892 Family [ConnectX-6 Dx]

ibdev2netdev -v | grep -i connect
# mlx5_0 (mt4125 - MCX623102AN-ADAT) ConnectX-6 Dx EN adapter card, 25GbE, Dual-port SFP28, PCIe 4.0 x16  fw 22.29.1016 port 1 (DOWN  ) ==> enp4s0f0 (Down)
# mlx5_1 (mt4125 - MCX623102AN-ADAT) ConnectX-6 Dx EN adapter card, 25GbE, Dual-port SFP28, PCIe 4.0 x16  fw 22.29.1016 port 1 (DOWN  ) ==> enp4s0f1 (Down)

# 103 rocky 8.4

# echo 'fastestmirror=1' >> /etc/dnf/dnf.conf

export VAR_HOST='rl_panlab103'

cp /etc/default/grub /etc/default/grub.bak
sed -i "/GRUB_CMDLINE_LINUX/s/resume=[^[:space:]]*//"  /etc/default/grub
sed -i "/GRUB_CMDLINE_LINUX/s/rd.lvm.lv=${VAR_HOST}\\/swap//"  /etc/default/grub
# https://unix.stackexchange.com/questions/403706/sed-insert-text-after-nth-character-preceding-following-a-given-string
sed -i '/GRUB_CMDLINE_LINUX/s/"/ intel_iommu=on iommu=pt  default_hugepagesz=1G hugepagesz=1G hugepages=16 rdblacklist=nouveau"/2' /etc/default/grub

grub2-mkconfig -o /boot/efi/EFI/rocky/grub.cfg

grub2-mkconfig -o /boot/grub2/grub.cfg

cat << EOF > /etc/modprobe.d/kvm-nested.conf
options kvm_intel nested=1  
options kvm-intel enable_shadow_vmcs=1   
options kvm-intel enable_apicv=1         
options kvm-intel ept=1                  
EOF

umount /home
swapoff  /dev/$VAR_HOST/swap

cp /etc/fstab /etc/fstab.bak
sed -i 's/^[^#]*home/#&/' /etc/fstab
sed -i 's/^[^#]*swap/#&/' /etc/fstab

lvremove -f /dev/$VAR_HOST/home
lvremove -f /dev/$VAR_HOST/swap

lvextend -l +100%FREE /dev/$VAR_HOST/root
xfs_growfs /dev/$VAR_HOST/root

# 103 driver install
# https://www.mellanox.com/products/infiniband-drivers/linux/mlnx_ofed

cd /data/down/MLNX_OFED_LINUX-5.4-1.0.3.0-rhel8.4-x86_64
yum install -y tcl tk kernel-modules-extra python36 make gcc-gfortran tcsh unbound
# ./mlnxofedinstall --force --distro rhel8.4
./mlnxofedinstall --dpdk --ovs-dpdk --upstream-libs --add-kernel-support --force --distro rhel8.4

# Device (04:00.0):
#         04:00.0 Ethernet controller: Mellanox Technologies MT2892 Family [ConnectX-6 Dx]
#         Link Width: x8 ( WARNING - device supports x16 )
#         PCI Link Speed: 8GT/s

# Device (04:00.1):
#         04:00.1 Ethernet controller: Mellanox Technologies MT2892 Family [ConnectX-6 Dx]
#         Link Width: x8 ( WARNING - device supports x16 )
#         PCI Link Speed: 8GT/s


# Installation finished successfully.


# Verifying...                          ################################# [100%]
# Preparing...                          ################################# [100%]
# Updating / installing...
#    1:mlnx-fw-updater-5.4-1.0.3.0      ################################# [100%]

# Added 'RUN_FW_UPDATER_ONBOOT=no to /etc/infiniband/openib.conf

# Initializing...
# Attempting to perform Firmware update...
# Querying Mellanox devices firmware ...

# Device #1:
# ----------

#   Device Type:      ConnectX6DX
#   Part Number:      MCX623102AN-ADA_Ax
#   Description:      ConnectX-6 Dx EN adapter card; 25GbE; Dual-port SFP28; PCIe 4.0/3.0 x16
#   PSID:             MT_0000000355
#   PCI Device Name:  04:00.0
#   Base GUID:        0c42a10300fa1852
#   Base MAC:         0c42a1fa1852
#   Versions:         Current        Available
#      FW             22.29.1016     22.31.1014
#      PXE            3.6.0204       3.6.0403
#      UEFI           14.22.0014     14.24.0013

#   Status:           Update required

# ---------
# Found 1 device(s) requiring firmware update...

# Device #1: Updating FW ...
# FSMST_INITIALIZE -   OK
# Writing Boot image component -   OK
# Done

# Restart needed for updates to take effect.
# Log File: /tmp/Tp8oUJN4tb
# Real log file: /tmp/MLNX_OFED_LINUX.145665.logs/fw_update.log
# To load the new driver, run:
# /etc/init.d/openibd restart

systemctl enable --now mst
systemctl enable --now openibd

cat << EOF > /etc/yum.repos.d/mlx.repo
[mlnx_ofed]
name=MLNX_OFED Repository
baseurl=file:///data/down/MLNX_OFED_LINUX-5.4-1.0.3.0-rhel8.4-x86_64/RPMS
enabled=1
gpgcheck=0
EOF

mlnx_qos -i enp4s0f0
# DCBX mode: OS controlled
# Priority trust state: pcp
# default priority:
# Receive buffer size (bytes): 0,156096,0,0,0,0,0,0,
# Cable len: 7
# PFC configuration:
#         priority    0   1   2   3   4   5   6   7
#         enabled     0   0   0   0   0   0   0   0
#         buffer      1   1   1   1   1   1   1   1
# tc: 1 ratelimit: unlimited, tsa: vendor
#          priority:  0
# tc: 0 ratelimit: unlimited, tsa: vendor
#          priority:  1
# tc: 2 ratelimit: unlimited, tsa: vendor
#          priority:  2
# tc: 3 ratelimit: unlimited, tsa: vendor
#          priority:  3
# tc: 4 ratelimit: unlimited, tsa: vendor
#          priority:  4
# tc: 5 ratelimit: unlimited, tsa: vendor
#          priority:  5
# tc: 6 ratelimit: unlimited, tsa: vendor
#          priority:  6
# tc: 7 ratelimit: unlimited, tsa: vendor
#          priority:  7

ethtool -l enp4s0f0
# Channel parameters for enp4s0f0:
# Pre-set maximums:
# RX:             n/a
# TX:             n/a
# Other:          512
# Combined:       24
# Current hardware settings:
# RX:             n/a
# TX:             n/a
# Other:          0
# Combined:       24

cat /boot/config-4.18.0-305.19.1.el8_4.x86_64 | grep -i CONFIG_XFRM_OFFLOAD
# CONFIG_XFRM_OFFLOAD=y

cat /boot/config-4.18.0-305.19.1.el8_4.x86_64 | grep -i CONFIG_INET_ESP_OFFLOAD
# CONFIG_INET_ESP_OFFLOAD=m

cat /boot/config-4.18.0-305.19.1.el8_4.x86_64 | grep -i CONFIG_INET6_ESP_OFFLOAD
# CONFIG_INET6_ESP_OFFLOAD=m

# in docs
# Mellanox ASAP2 with OVS Deployment

ethtool -i enp4s0f0 | head -5
# driver: mlx5_core
# version: 5.4-1.0.3
# firmware-version: 22.31.1014 (MT_0000000355)
# expansion-rom-version:
# bus-info: 0000:04:00.0

# in docs
# OVS Hardware Offloads Configuration
dnf install -y git cmake gcc libnl3-devel libudev-devel make pkgconfig valgrind-devel pandoc libibverbs libmlx5 libmnl-devel

mkdir -p /data/soft
cd /data/soft

# wget https://github.com/mesonbuild/meson/releases/download/0.59.2/meson-0.59.2.tar.gz
# tar zvxf meson-0.59.2.tar.gz
# cd /data/soft/meson-0.59.2
# python3 setup.py install

dnf config-manager --set-enabled powertools
dnf install -y ninja-build meson

# dnf group list
dnf groupinstall -y 'Development Tools'
# install dpdk
dnf install -y mlnx-dpdk mlnx-dpdk-devel numactl-devel openvswitch  openvswitch-selinux-policy libnl3-devel openssl-devel zlib-devel libpcap-devel elfutils-libelf-devel 
# https://doc.dpdk.org/guides/linux_gsg/sys_reqs.html#compilation-of-the-dpdk
pip3 install --user pyelftools

echo 'export PATH=$PATH:/opt/mellanox/dpdk/bin/' >> ~/.bash_profile

cd /data/soft/
wget https://fast.dpdk.org/rel/dpdk-20.11.3.tar.xz
tar vxf dpdk-20.11.3.tar.xz
# https://core.dpdk.org/doc/quick-start/
cd /data/soft/dpdk-stable-20.11.3/
# meson -Dexamples=all build
meson --reconfigure -Dexamples=all build
ninja -C build

export PKG_CONFIG_PATH=/opt/mellanox/dpdk/lib64/pkgconfig/
cd /data/soft/dpdk-stable-20.11.3/examples/vdpa
make -j 

# install kvm with qemu
dnf -y groupinstall "Server with GUI"

dnf -y install qemu-kvm libvirt libguestfs-tools virt-install virt-viewer virt-manager tigervnc-server

systemctl disable --now firewalld
systemctl enable --now libvirtd

# set sriov
# https://docs.mellanox.com/pages/viewpage.action?pageId=52014545#OVSOffloadUsingASAP%C2%B2Direct-SettingUpSR-IOV
# https://docs.mellanox.com/pages/viewpage.action?pageId=52011200#OVSOffloadUsingASAP%C2%B2Direct-SettingUpSR-IOV

# go to system bios, enable sr-iov feature
# check out your server's mother board guide
# for dell, check here 
# https://infohub.delltechnologies.com/l/sr-iov-enablement-for-container-pods-in-openshift-4-3-ready-stack/enable-sr-iov-bits-from-bios

# cd /data/down/MLNX_OFED_LINUX-5.4-1.0.3.0-rhel8.4-x86_64
# ./mlnxofedinstall --ovs-dpdk --upstream-libs --force --distro rhel8.4

lspci -D | grep -i mell
# 0000:04:00.0 Ethernet controller: Mellanox Technologies MT2892 Family [ConnectX-6 Dx]
# 0000:04:00.1 Ethernet controller: Mellanox Technologies MT2892 Family [ConnectX-6 Dx]

lshw -c network -businfo
# Bus info          Device     Class          Description
# =======================================================
# pci@0000:02:00.0  eno3       network        NetXtreme BCM5720 2-port Gigabit Ethernet PCIe
# pci@0000:02:00.1  eno4       network        NetXtreme BCM5720 2-port Gigabit Ethernet PCIe
# pci@0000:01:00.0  eno1       network        NetXtreme BCM5720 2-port Gigabit Ethernet PCIe
# pci@0000:01:00.1  eno2       network        NetXtreme BCM5720 2-port Gigabit Ethernet PCIe
# pci@0000:04:00.0  enp4s0f0   network        MT2892 Family [ConnectX-6 Dx]
# pci@0000:04:00.1  enp4s0f1   network        MT2892 Family [ConnectX-6 Dx]

# so we will use enp4s0f0

ethtool -i enp4s0f0 | head -5
# driver: mlx5_core
# version: 5.4-1.0.3
# firmware-version: 22.31.1014 (MT_0000000355)
# expansion-rom-version:
# bus-info: 0000:04:00.0

cat /sys/class/net/enp4s0f0/device/sriov_totalvfs
# 4

# UCTX_EN is for enable DevX
# DevX allows to access firmware objects
mlxconfig -y -d 0000:04:00.0 set SRIOV_EN=1 UCTX_EN=1 NUM_OF_VFS=8
# Device #1:
# ----------

# Device type:    ConnectX6DX
# Name:           MCX623102AN-ADA_Ax
# Description:    ConnectX-6 Dx EN adapter card; 25GbE; Dual-port SFP28; PCIe 4.0/3.0 x16
# Device:         0000:04:00.0

# Configurations:                              Next Boot       New
#          SRIOV_EN                            True(1)         True(1)
#          UCTX_EN                             True(1)         True(1)
#          NUM_OF_VFS                          4               8

#  Apply new Configuration? (y/n) [n] : y
# Applying... Done!
# -I- Please reboot machine to load new configurations.
reboot

mlxconfig -y -d 0000:04:00.0 query SRIOV_EN
mlxconfig -y -d 0000:04:00.0 query UCTX_EN
mlxconfig -y -d 0000:04:00.0 query NUM_OF_VFS

# total vf change from 4 to 8
cat /sys/class/net/enp4s0f0/device/sriov_totalvfs
# 8

# Turn ON SR-IOV on the PF device. 
cat /sys/class/net/enp4s0f0/device/sriov_numvfs
# 0
echo 2 > /sys/class/net/enp4s0f0/device/sriov_numvfs
cat /sys/class/net/enp4s0f0/device/sriov_numvfs
# 2

ip -d link
# ......
# 6: enp4s0f0: <NO-CARRIER,BROADCAST,MULTICAST,UP> mtu 1500 qdisc mq state DOWN mode DEFAULT group default qlen 1000
#     link/ether 0c:42:a1:fa:18:52 brd ff:ff:ff:ff:ff:ff promiscuity 0 minmtu 68 maxmtu 9978 addrgenmode none numtxqueues 712 numrxqueues 48 gso_max_size 65536 gso_max_segs 65535 portname p0 switchid 5218fa0003a1420c
#     vf 0     link/ether 00:00:00:00:00:00 brd ff:ff:ff:ff:ff:ff, spoof checking off, link-state auto, trust off, query_rss off
#     vf 1     link/ether 00:00:00:00:00:00 brd ff:ff:ff:ff:ff:ff, spoof checking off, link-state auto, trust off, query_rss off
# 7: enp4s0f1: <NO-CARRIER,BROADCAST,MULTICAST,UP> mtu 1500 qdisc mq state DOWN mode DEFAULT group default qlen 1000
#     link/ether 0c:42:a1:fa:18:53 brd ff:ff:ff:ff:ff:ff promiscuity 0 minmtu 68 maxmtu 9978 addrgenmode none numtxqueues 712 numrxqueues 48 gso_max_size 65536 gso_max_segs 65535 portname p1 switchid 5218fa0003a1420c
# ......
# 10: enp4s0f0v0: <NO-CARRIER,BROADCAST,MULTICAST,UP> mtu 1500 qdisc mq state DOWN mode DEFAULT group default qlen 1000
#     link/ether d2:4d:06:0c:44:65 brd ff:ff:ff:ff:ff:ff permaddr 32:07:d6:4c:36:d9 promiscuity 0 minmtu 68 maxmtu 9978 addrgenmode none numtxqueues 600 numrxqueues 22 gso_max_size 65536 gso_max_segs 65535 portname p0
# 11: enp4s0f0v1: <NO-CARRIER,BROADCAST,MULTICAST,UP> mtu 1500 qdisc mq state DOWN mode DEFAULT group default qlen 1000
#     link/ether ae:cd:54:48:21:8b brd ff:ff:ff:ff:ff:ff permaddr ee:9c:31:c2:d6:85 promiscuity 0 minmtu 68 maxmtu 9978 addrgenmode none numtxqueues 600 numrxqueues 22 gso_max_size 65536 gso_max_segs 65535 portname p0

ip link set enp4s0f0 vf 0 mac e4:11:22:33:44:50
ip link set enp4s0f0 vf 1 mac e4:11:22:33:44:51

ip link show enp4s0f0
# 6: enp4s0f0: <NO-CARRIER,BROADCAST,MULTICAST,UP> mtu 1500 qdisc mq state DOWN mode DEFAULT group default qlen 1000
#     link/ether 0c:42:a1:fa:18:52 brd ff:ff:ff:ff:ff:ff
#     vf 0     link/ether e4:11:22:33:44:50 brd ff:ff:ff:ff:ff:ff, spoof checking off, link-state auto, trust off, query_rss off
#     vf 1     link/ether e4:11:22:33:44:51 brd ff:ff:ff:ff:ff:ff, spoof checking off, link-state auto, trust off, query_rss off

# Running Hardware vDPA 
# Hardware vDPA supports SwitchDev mode only.
# Create the ASAP2 environment:
# Create the VFs. 
# Enter switchdev mode.
# Set up OVS. 

lspci -D | grep -i mell
# 0000:04:00.0 Ethernet controller: Mellanox Technologies MT2892 Family [ConnectX-6 Dx]
# 0000:04:00.1 Ethernet controller: Mellanox Technologies MT2892 Family [ConnectX-6 Dx]
# 0000:04:00.2 Ethernet controller: Mellanox Technologies ConnectX Family mlx5Gen Virtual Function
# 0000:04:00.3 Ethernet controller: Mellanox Technologies ConnectX Family mlx5Gen Virtual Function

# SwitchDev Configuration
# OVS-DPDK Hardware Offloads
# Unbind the VFs. 
echo 0000:04:00.2 > /sys/bus/pci/drivers/mlx5_core/unbind
echo 0000:04:00.3 > /sys/bus/pci/drivers/mlx5_core/unbind

# Change the eSwitch mode from Legacy to SwitchDev on the PF device.
# This will also create the VF representor netdevices in the host OS. 
devlink dev eswitch show pci/0000:04:00.0
# pci/0000:04:00.0: mode legacy inline-mode none encap-mode basic

devlink dev eswitch set pci/0000:04:00.0 mode switchdev

devlink dev eswitch show pci/0000:04:00.0
# pci/0000:04:00.0: mode switchdev inline-mode none encap-mode basic

# Bind the VFs. 
echo 0000:04:00.2 > /sys/bus/pci/drivers/mlx5_core/bind
echo 0000:04:00.3 > /sys/bus/pci/drivers/mlx5_core/bind

ip -d link
# ......
# 6: enp4s0f0: <NO-CARRIER,BROADCAST,MULTICAST,UP> mtu 1500 qdisc mq state DOWN mode DEFAULT group default qlen 1000
#     link/ether 0c:42:a1:fa:18:52 brd ff:ff:ff:ff:ff:ff promiscuity 0 minmtu 68 maxmtu 9978 addrgenmode none numtxqueues 712 numrxqueues 48 gso_max_size 65536 gso_max_segs 65535 portname p0 switchid 5218fa0003a1420c
#     vf 0     link/ether e4:11:22:33:44:50 brd ff:ff:ff:ff:ff:ff, spoof checking off, link-state disable, trust off, query_rss off
#     vf 1     link/ether e4:11:22:33:44:51 brd ff:ff:ff:ff:ff:ff, spoof checking off, link-state disable, trust off, query_rss off
# ......
# 12: enp4s0f0_0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc mq state UP mode DEFAULT group default qlen 1000
#     link/ether 32:08:64:fe:4d:83 brd ff:ff:ff:ff:ff:ff promiscuity 0 minmtu 68 maxmtu 9978 addrgenmode none numtxqueues 537 numrxqueues 24 gso_max_size 65536 gso_max_segs 65535 portname pf0vf0 switchid 5218fa0003a1420c
# 13: enp4s0f0_1: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc mq state UP mode DEFAULT group default qlen 1000
#     link/ether d6:39:dc:f9:b4:4a brd ff:ff:ff:ff:ff:ff promiscuity 0 minmtu 68 maxmtu 9978 addrgenmode none numtxqueues 537 numrxqueues 24 gso_max_size 65536 gso_max_segs 65535 portname pf0vf1 switchid 5218fa0003a1420c
# 16: enp4s0f0v0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc mq state UP mode DEFAULT group default qlen 1000
#     link/ether e4:11:22:33:44:50 brd ff:ff:ff:ff:ff:ff promiscuity 0 minmtu 68 maxmtu 9978 addrgenmode none numtxqueues 600 numrxqueues 22 gso_max_size 65536 gso_max_segs 65535 portname p0
# 17: enp4s0f0v1: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc mq state UP mode DEFAULT group default qlen 1000
#     link/ether e4:11:22:33:44:51 brd ff:ff:ff:ff:ff:ff promiscuity 0 minmtu 68 maxmtu 9978 addrgenmode none numtxqueues 600 numrxqueues 22 gso_max_size 65536 gso_max_segs 65535 portname p0

systemctl enable --now openvswitch
# Create an OVS bridge (here it's named ovs-sriov). 
ovs-vsctl add-br ovs-sriov
systemctl restart openvswitch

ovs-vsctl set Open_vSwitch . other_config:hw-offload=true

# https://gist.github.com/djoreilly/c5ea44663c133b246dd9d42b921f7646
ovs-vsctl list open_vswitch
# _uuid               : 79f565b0-e363-4e8b-b7b0-bb5592e7c2f6
# bridges             : [93aa49b1-c3e6-4428-9c7d-b7471f98d558]
# cur_cfg             : 2
# datapath_types      : [netdev, system]
# datapaths           : {}
# db_version          : "8.2.0"
# dpdk_initialized    : false
# dpdk_version        : "MLNX_DPDK 20.11.2.2.10"
# external_ids        : {hostname=panlab103, rundir="/var/run/openvswitch", system-id="6fde648b-bea1-46f9-8d28-35b8b728128b"}
# iface_types         : [erspan, geneve, gre, gtpu, internal, ip6erspan, ip6gre, lisp, patch, stt, system, tap, vxlan]
# manager_options     : []
# next_cfg            : 2
# other_config        : {hw-offload="true"}
# ovs_version         : "2.14.1"
# ssl                 : []
# statistics          : {}
# system_type         : rocky
# system_version      : "8.4"

# Add the PF and the VF representor netdevices as OVS ports. 
ovs-vsctl add-port ovs-sriov enp4s0f0
ovs-vsctl add-port ovs-sriov enp4s0f0_0
ovs-vsctl add-port ovs-sriov enp4s0f0_1

# Make sure to bring up the PF and representor netdevices. 
ip link set dev enp4s0f0 up
ip link set dev enp4s0f0_0 up
ip link set dev enp4s0f0_1 up

ip link set dev enp4s0f0v0 up
ip link set dev enp4s0f0v1 up

ovs-vsctl show
# 79f565b0-e363-4e8b-b7b0-bb5592e7c2f6
#     Bridge ovs-sriov
#         Port enp4s0f0_0
#             Interface enp4s0f0_0
#                 error: "could not open network device enp4s0f0_0 (No such device)"
#         Port enp4s0f0
#             Interface enp4s0f0
#         Port ovs-sriov
#             Interface ovs-sriov
#                 type: internal
#         Port enp4s0f0_1
#             Interface enp4s0f0_1
#                 error: "could not open network device enp4s0f0_1 (No such device)"
#     ovs_version: "2.14.1"

ovs-dpctl show
# system@ovs-system:
#   lookups: hit:0 missed:0 lost:0
#   flows: 0
#   masks: hit:0 total:0 hit/pkt:0.00
#   port 0: ovs-system (internal)
#   port 1: ovs-sriov (internal)
#   port 2: enp4s0f0
#   port 3: enp4s0f0_0
#   port 4: enp4s0f0_1

ip addr add 192.168.77.21/24 dev enp4s0f0v0
ip addr add 192.168.77.22/24 dev enp4s0f0v1
ping -I enp4s0f0v0 192.168.77.22
# here is wrong, I think it should ping ok
# boot 105, and ping doesn't work either

# ip addr del 192.168.77.21/24 dev enp4s0f0v0
# ip addr del 192.168.77.22/24 dev enp4s0f0v1

ovs-dpctl dump-flows
ovs-appctl dpctl/dump-flows type=offloaded
```
## vdpa
```bash
# vdpa
# OVS-DPDK Hardware Offloads
ovs-vsctl del-port ovs-sriov enp4s0f0
ovs-vsctl del-port ovs-sriov enp4s0f0_0
ovs-vsctl del-port ovs-sriov enp4s0f0_1
ovs-vsctl del-br ovs-sriov

ovs-vsctl --no-wait set Open_vSwitch . other_config:dpdk-init=true
ovs-vsctl set Open_vSwitch . other_config:hw-offload=true
# Configure the DPDK white list. 
ovs-vsctl --no-wait set Open_vSwitch . other_config:dpdk-extra="-w 0000:04:00.0,representor=[0],dv_flow_en=1,dv_esw_en=1,dv_xmeta_en=1 --log-level=mlx5,8"

# https://doc.dpdk.org/guides/linux_gsg/sys_reqs.html#compilation-of-the-dpdk
mkdir -p /hugepages
# mount -t hugetlbfs hugetlbfs /hugepages
echo 'nodev /hugepages hugetlbfs pagesize=1GB 0 0' >> /etc/fstab
mount /hugepages

cat /sys/devices/system/node/node0/hugepages/hugepages-1048576kB/nr_hugepages
# 4
cat /sys/devices/system/node/node1/hugepages/hugepages-1048576kB/nr_hugepages
# 4

echo 4 > /sys/devices/system/node/node0/hugepages/hugepages-1048576kB/nr_hugepages 
echo 4 > /sys/devices/system/node/node1/hugepages/hugepages-1048576kB/nr_hugepages

systemctl restart openvswitch
# failed to start, 
# 2021-10-22T12:56:14.944Z|00019|dpdk|ERR|EAL: Cannot remap memory for rte_config
# 2021-10-22T12:56:14.944Z|00020|dpdk|ERR|EAL: Cannot init config
# 2021-10-22T12:56:14.944Z|00021|dpdk|EMER|Unable to initialize DPDK: Success

ovs-vsctl --no-wait set Open_vSwitch . other_config:dpdk-init=false
ovs-vsctl --no-wait set Open_vSwitch . other_config:dpdk-extra=" "

# debug
cat /var/log/openvswitch/ovs-vswitchd.log

dpdk-devbind.py --status
# Network devices using DPDK-compatible driver
# ============================================
# 0000:04:00.2 'ConnectX Family mlx5Gen Virtual Function 101e' drv=vfio-pci unused=mlx5_core
# 0000:04:00.3 'ConnectX Family mlx5Gen Virtual Function 101e' drv=vfio-pci unused=mlx5_core

# https://developers.redhat.com/blog/2017/06/28/ovs-dpdk-parameters-dealing-with-multi-numa
lspci -vmms ${PCINUM} | grep NUMANode
# NUMANode:       0

# https://fast.dpdk.org/doc/pdf-guides-18.11/linux_gsg-18.11.pdf

```

# 105
```bash
# on 105
lspci |grep -i mell
# 05:00.0 Infiniband controller: Mellanox Technologies MT28908 Family [ConnectX-6]
# 43:00.0 Ethernet controller: Mellanox Technologies MT2892 Family [ConnectX-6 Dx]
# 43:00.1 Ethernet controller: Mellanox Technologies MT2892 Family [ConnectX-6 Dx]

lshw -c network -businfo
# Bus info          Device        Class          Description
# ==========================================================
# pci@0000:02:00.0  eno3          network        NetXtreme BCM5720 2-port Gigabit Ethernet PCIe
# pci@0000:02:00.1  eno4          network        NetXtreme BCM5720 2-port Gigabit Ethernet PCIe
# pci@0000:01:00.0  eno1          network        NetXtreme BCM5720 2-port Gigabit Ethernet PCIe
# pci@0000:01:00.1  eno2          network        NetXtreme BCM5720 2-port Gigabit Ethernet PCIe
# pci@0000:05:00.0  ib0           network        MT28908 Family [ConnectX-6]
# pci@0000:43:00.0  enp67s0f0     network        MT2892 Family [ConnectX-6 Dx]
# pci@0000:43:00.1  enp67s0f1     network        MT2892 Family [ConnectX-6 Dx]

export VAR_HOST='rl_panlab105'

cat << EOF > /etc/modprobe.d/blacklist-nouveau.conf
blacklist nouveau
options nouveau modeset=0
EOF
dracut --force

export IFNAME=enp67s0f0
export PCINUM=0000:43:00.0

mlxconfig -y -d $PCINUM set SRIOV_EN=1 UCTX_EN=1 NUM_OF_VFS=8
reboot

mlxconfig -y -d $PCINUM query SRIOV_EN
mlxconfig -y -d $PCINUM query UCTX_EN
mlxconfig -y -d $PCINUM query NUM_OF_VFS

cat /sys/class/net/$IFNAME/device/sriov_totalvfs
# 8

# Turn ON SR-IOV on the PF device. 
cat /sys/class/net/$IFNAME/device/sriov_numvfs
# 0
echo 2 > /sys/class/net/$IFNAME/device/sriov_numvfs
cat /sys/class/net/$IFNAME/device/sriov_numvfs
# 2

ip link set $IFNAME vf 0 mac e4:11:22:33:55:60
ip link set $IFNAME vf 1 mac e4:11:22:33:55:61

echo ${PCINUM%%.*}.2 > /sys/bus/pci/drivers/mlx5_core/unbind
echo ${PCINUM%%.*}.3 > /sys/bus/pci/drivers/mlx5_core/unbind

devlink dev eswitch set pci/$PCINUM mode switchdev
devlink dev eswitch show pci/$PCINUM
# pci/0000:43:00.0: mode switchdev inline-mode none encap-mode basic

echo ${PCINUM%%.*}.2 > /sys/bus/pci/drivers/mlx5_core/bind
echo ${PCINUM%%.*}.3 > /sys/bus/pci/drivers/mlx5_core/bind

ip addr add 192.168.77.31/24 dev ${IFNAME}v0

systemctl enable --now openvswitch
# Create an OVS bridge (here it's named ovs-sriov). 
ovs-vsctl add-br ovs-sriov

systemctl restart openvswitch

ovs-vsctl add-port ovs-sriov ${IFNAME}
ovs-vsctl add-port ovs-sriov ${IFNAME}_0
ovs-vsctl add-port ovs-sriov ${IFNAME}_1

ip link set dev ${IFNAME} up
ip link set dev ${IFNAME}_0 up
ip link set dev ${IFNAME}_1 up

ip link set dev ${IFNAME}v0 up
ip link set dev ${IFNAME}v1 up

cat /sys/class/net/${IFNAME}/compat/devlink/mode
# switchdev

ovs-vsctl show
ovs-dpctl show

# ovs-vsctl --no-wait set Open_vSwitch . other_config:dpdk-init=true
ovs-vsctl --no-wait set Open_vSwitch . other_config:dpdk-init=try
ovs-vsctl set Open_vSwitch . other_config:hw-offload=true
# Configure the DPDK white list. 
ovs-vsctl --no-wait set Open_vSwitch . other_config:dpdk-extra="-w ${PCINUM},representor=[0-1],dv_flow_en=1,dv_esw_en=1,dv_xmeta_en=1 --log-level=mlx5,8"
ovs-vsctl --no-wait set Open_vSwitch . other_config:dpdk-hugepage-dir=/hugepages

mkdir -p /hugepages
mount -t hugetlbfs hugetlbfs -o mode=775 /hugepages

umount /hugepages
mount -t hugetlbfs none /hugepages

cat /var/log/openvswitch/ovs-vswitchd.log

/opt/mellanox/dpdk/bin/testpmd -w ${PCINUM}

sysctl -w vm.nr_hugepages=2048

cat /proc/meminfo | grep -i huge

ovs-vsctl del-port ovs-sriov ${IFNAME}
ovs-vsctl del-port ovs-sriov ${IFNAME}_0
ovs-vsctl del-port ovs-sriov ${IFNAME}_1
ovs-vsctl del-br ovs-sriov


ovs-vsctl --no-wait set Open_vSwitch . other_config:dpdk-init=false
ovs-vsctl --no-wait set Open_vSwitch . other_config:dpdk-extra=" "

systemctl restart openvswitch

lspci |grep -i mell
# 05:00.0 Infiniband controller: Mellanox Technologies MT28908 Family [ConnectX-6]
# 43:00.0 Ethernet controller: Mellanox Technologies MT2892 Family [ConnectX-6 Dx]
# 43:00.1 Ethernet controller: Mellanox Technologies MT2892 Family [ConnectX-6 Dx]
# 43:00.2 Ethernet controller: Mellanox Technologies ConnectX Family mlx5Gen Virtual Function
# 43:00.3 Ethernet controller: Mellanox Technologies ConnectX Family mlx5Gen Virtual Function

cd /data/soft/dpdk-stable-20.11.3/examples/vdpa/build
./vdpa -w ${PCINUM%%.*}.2,class=vdpa --log-level=pmd,info -- -i
create /tmp/sock-virtio0 0000:43:00.2

# https://doc.dpdk.org/guides/sample_app_ug/vdpa.html
modprobe vfio-pci
/data/soft/dpdk-stable-20.11.3/usertools//dpdk-devbind.py -b vfio-pci 43:00.2
/data/soft/dpdk-stable-20.11.3/examples/vdpa/build/vdpa -a ${PCINUM%%.*}.2,class=vdpa --log-level=pmd,info -- -i
create /tmp/sock-virtio0 0000:43:00.2

# debug
# https://mymellanox.force.com/mellanoxcommunity/s/article/Basic-Debug-utilities-with-OVS-DPDK-offload-ASAP-Direct
dpdk-testpmd -a ${PCINUM} --log-level=9
dpdk-testpmd -a ${PCINUM%%.*}.2  --log-level=9

dpdk-hugepages.py  -s
# Node Pages Size Total
# 0    8     1Gb    8Gb
# 1    8     1Gb    8Gb

# Hugepages mounted on /dev/hugepages /hugepages

modprobe vfio-pci

ovs-vswitchd --version
# ovs-vswitchd (Open vSwitch) 2.14.1
# MLNX_DPDK 20.11.2.2.10

# https://doc.dpdk.org/guides/linux_gsg/linux_drivers.html
# modprobe vfio-pci enable_sriov=1
modprobe vfio-pci
dpdk-devbind.py -b vfio-pci ${PCINUM%%.*}.2
dpdk-devbind.py -b vfio-pci ${PCINUM%%.*}.3

dpdk-devbind.py --status

# https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/performance_tuning_guide/sect-red_hat_enterprise_linux-performance_tuning_guide-memory-configuring-huge-pages
numastat -cm | egrep 'Node|Huge'
# Token Node not in hash table.
# Token Node not in hash table.
# Token Node not in hash table.
# Token Node not in hash table.
# Token Node not in hash table.
# Token Node not in hash table.
#                  Node 0 Node 1  Total
# AnonHugePages        50    110    160
# ShmemHugePages        0      0      0
# HugePages_Total    8192   8192  16384
# HugePages_Free     6144   7168  13312
# HugePages_Surp        0      0      0


cat /proc/$( pgrep -o ovs-vswitchd )/limits
# Limit                     Soft Limit           Hard Limit           Units
# Max cpu time              unlimited            unlimited            seconds
# Max file size             unlimited            unlimited            bytes
# Max data size             unlimited            unlimited            bytes
# Max stack size            2097152              2097152              bytes
# Max core file size        34359738368          34359738368          bytes
# Max resident set          unlimited            unlimited            bytes
# Max processes             577685               577685               processes
# Max open files            65535                65535                files
# Max locked memory         65536                65536                bytes
# Max address space         unlimited            unlimited            bytes
# Max file locks            unlimited            unlimited            locks
# Max pending signals       577685               577685               signals
# Max msgqueue size         819200               819200               bytes
# Max nice priority         0                    0
# Max realtime priority     0                    0
# Max realtime timeout      unlimited            unlimited            us

# cat /proc/$( pgrep -o ovs-vswitchd )/smaps

# https://www.cnblogs.com/arnoldlu/p/14028825.html
hugeadm --list-all-mounts
# Mount Point          Options
# /dev/hugepages       rw,seclabel,relatime,pagesize=1024M

hugeadm --pool-list
#       Size  Minimum  Current  Maximum  Default
#    2097152        0        0        0
# 1073741824       16       16       16        *

dnf install -y libhugetlbfs numactl

huge_page_setup_helper.py

ausearch -m avc --start recent -i
# type=PROCTITLE msg=audit(10/25/2021 13:44:04.538:262) : proctitle=ovs-vswitchd unix:/var/run/openvswitch/db.sock -vconsole:emer -vsyslog:err -vfile:info --mlockall --user openvswitch:hugetlbfs -
# type=SYSCALL msg=audit(10/25/2021 13:44:04.538:262) : arch=x86_64 syscall=mmap success=no exit=EACCES(Permission denied) a0=0x100000000 a1=0x7000 a2=PROT_READ|PROT_WRITE a3=MAP_SHARED|MAP_FIXED items=0 ppid=24047 pid=24049 auid=unset uid=openvswitch gid=hugetlbfs euid=openvswitch suid=openvswitch fsuid=openvswitch egid=hugetlbfs sgid=hugetlbfs fsgid=hugetlbfs tty=(none) ses=unset comm=ovs-vswitchd exe=/usr/sbin/ovs-vswitchd subj=system_u:system_r:openvswitch_t:s0 key=(null)
# type=AVC msg=audit(10/25/2021 13:44:04.538:262) : avc:  denied  { map } for  pid=24049 comm=ovs-vswitchd path=/run/openvswitch/dpdk/rte/config dev="tmpfs" ino=43126 scontext=system_u:system_r:openvswitch_t:s0 tcontext=system_u:object_r:openvswitch_var_run_t:s0 tclass=file permissive=0

audit2allow -a -M wzh-mellanox-ovs-dpdk
# Use the semodule command to persistently load the new module in SELinux.
semodule -i wzh-mellanox-ovs-dpdk.pp

semodule --list-modules=full | grep wzh
semodule -r wzh-mellanox-ovs-dpdk

```

## ovs offload shell

```bash

cat << 'EOF' > /data/ovs-offload-env.sh
#!/usr/bin/env bash

set -e
set -x

systemctl restart openvswitch
ovs-vsctl --no-wait set Open_vSwitch . other_config:dpdk-init=try
systemctl restart openvswitch

ip link set dev ${IFNAME} down || true
ip link set dev ${IFNAME}_0 down || true
ip link set dev ${IFNAME}_1 down || true

ip link set dev ${IFNAME}v0 down || true
ip link set dev ${IFNAME}v1 down || true

ovs-vsctl del-port ovs-sriov ${IFNAME} || true
ovs-vsctl del-port ovs-sriov ${IFNAME}_0 || true
ovs-vsctl del-port ovs-sriov ${IFNAME}_1 || true
ovs-vsctl del-br ovs-sriov || true

ovs-vsctl del-port br0-ovs pf0vf0 || true
ovs-vsctl del-port br0-ovs pf0vf1 || true
ovs-vsctl del-port br0-ovs pf0 || true
ovs-vsctl del-br br0-ovs || true

ovs-vsctl --no-wait set Open_vSwitch . other_config:dpdk-init=false
ovs-vsctl --no-wait set Open_vSwitch . other_config:dpdk-extra=" "
ovs-vsctl --no-wait set Open_vSwitch . other_config={}

# Turn off SR-IOV on the PF device. 
echo 0 > /sys/class/net/$IFNAME/device/sriov_numvfs
cat /sys/class/net/$IFNAME/device/sriov_numvfs
# 0

systemctl restart openvswitch

# Turn ON SR-IOV on the PF device. 
echo 2 > /sys/class/net/$IFNAME/device/sriov_numvfs
cat /sys/class/net/$IFNAME/device/sriov_numvfs
# 2

ip link set $IFNAME vf 0 mac ${VF1MAC}
ip link set $IFNAME vf 1 mac ${VF2MAC}

echo ${PCINUM%%.*}.2 > /sys/bus/pci/drivers/mlx5_core/unbind || true
echo ${PCINUM%%.*}.3 > /sys/bus/pci/drivers/mlx5_core/unbind || true

devlink dev eswitch set pci/$PCINUM mode switchdev
devlink dev eswitch show pci/$PCINUM
# # pci/0000:43:00.0: mode switchdev inline-mode none encap-mode basic

echo ${PCINUM%%.*}.2 > /sys/bus/pci/drivers/mlx5_core/bind
echo ${PCINUM%%.*}.3 > /sys/bus/pci/drivers/mlx5_core/bind

# systemctl enable --now openvswitch
# systemctl restart openvswitch

# Create an OVS bridge (here it's named ovs-sriov). 
ovs-vsctl add-br ovs-sriov

ovs-vsctl set Open_vSwitch . other_config:hw-offload=true

systemctl restart openvswitch

ovs-vsctl add-port ovs-sriov ${IFNAME}
ovs-vsctl add-port ovs-sriov ${IFNAME}_0
ovs-vsctl add-port ovs-sriov ${IFNAME}_1

ip link set dev ${IFNAME} up
ip link set dev ${IFNAME}_0 up
ip link set dev ${IFNAME}_1 up

ip link set dev ${IFNAME}v0 up
ip link set dev ${IFNAME}v1 up

# systemctl restart openvswitch

ip addr add ${VF1IP} dev ${IFNAME}v0
ip addr add ${VF2IP} dev ${IFNAME}v1

EOF

# for 103
export IFNAME=enp4s0f0
export PCINUM=0000:04:00.0
export VF1MAC=e4:11:22:33:44:50
export VF2MAC=e4:11:22:33:44:51
export VF1IP=192.168.55.21/24
export VF2IP=192.168.55.22/24
bash /data/ovs-offload-env.sh

# for 105
export IFNAME=enp67s0f0
export PCINUM=0000:43:00.0
export VF1MAC=e4:11:22:33:55:60
export VF2MAC=e4:11:22:33:55:61
export VF1IP=192.168.55.31/24
export VF2IP=192.168.55.32/24
bash /data/ovs-offload-env.sh

/data/soft/dpdk-stable-20.11.3/examples/vdpa/build/vdpa -w ${PCINUM%%.*}.2,class=vdpa --log-level=pmd,info -- -i
create /tmp/sock-virtio0 0000:43:00.2

```

## ovs dpdk shell

```bash

cat << 'EOF' > /data/ovs-dpdk-env.sh
#!/usr/bin/env bash

set -e
set -x

ovs-vsctl --no-wait set Open_vSwitch . other_config:dpdk-init=try
systemctl restart openvswitch

ip link set dev ${IFNAME} down || true
ip link set dev ${IFNAME}_0 down || true
ip link set dev ${IFNAME}_1 down || true

ip link set dev ${IFNAME}v0 down || true
ip link set dev ${IFNAME}v1 down || true

ovs-vsctl del-port ovs-sriov ${IFNAME} || true
ovs-vsctl del-port ovs-sriov ${IFNAME}_0 || true
ovs-vsctl del-port ovs-sriov ${IFNAME}_1 || true
ovs-vsctl del-br ovs-sriov || true

ovs-vsctl del-port br0-ovs pf0vf0 || true
ovs-vsctl del-port br0-ovs pf0vf1 || true
ovs-vsctl del-port br0-ovs pf0 || true
ovs-vsctl del-port br0-ovs vdpa0 || true
ovs-vsctl del-br br0-ovs || true

ovs-vsctl --no-wait set Open_vSwitch . other_config:dpdk-init=false
ovs-vsctl --no-wait set Open_vSwitch . other_config:dpdk-extra=" "
ovs-vsctl --no-wait set Open_vSwitch . other_config={}

systemctl restart openvswitch

# Turn off SR-IOV on the PF device. 
echo 0 > /sys/class/net/$IFNAME/device/sriov_numvfs
cat /sys/class/net/$IFNAME/device/sriov_numvfs
# 0

# Turn ON SR-IOV on the PF device. 
echo 2 > /sys/class/net/$IFNAME/device/sriov_numvfs
cat /sys/class/net/$IFNAME/device/sriov_numvfs
# 2

# VAR_TMP_PCI=${PCINUM#*:}

# modprobe vfio-pci
# dpdk-devbind.py -b vfio-pci ${PCINUM%%.*}.2
# dpdk-devbind.py -b vfio-pci ${PCINUM%%.*}.3

ip link set $IFNAME vf 0 mac ${VF1MAC}
ip link set $IFNAME vf 1 mac ${VF2MAC}

echo ${PCINUM%%.*}.2 > /sys/bus/pci/drivers/mlx5_core/unbind || true
echo ${PCINUM%%.*}.3 > /sys/bus/pci/drivers/mlx5_core/unbind || true

devlink dev eswitch set pci/$PCINUM mode switchdev
devlink dev eswitch show pci/$PCINUM
# pci/0000:43:00.0: mode switchdev inline-mode none encap-mode basic

echo ${PCINUM%%.*}.2 > /sys/bus/pci/drivers/mlx5_core/bind
echo ${PCINUM%%.*}.3 > /sys/bus/pci/drivers/mlx5_core/bind

# systemctl enable --now openvswitch
# systemctl restart openvswitch

# Create an OVS bridge (here it's named ovs-sriov). 
# ovs-vsctl add-br ovs-sriov

ovs-vsctl --no-wait set Open_vSwitch . other_config:dpdk-init=true
# ovs-vsctl --no-wait set Open_vSwitch . other_config:dpdk-init=try
ovs-vsctl --no-wait set Open_vSwitch . other_config:hw-offload=true
# Configure the DPDK white list. 
# ovs-vsctl --no-wait set Open_vSwitch . other_config:dpdk-extra="-w ${PCINUM},representor=[0,1],dv_flow_en=1,dv_esw_en=1,dv_xmeta_en=1 --log-level=mlx5,8 --log-level=lib.eal:debug "
ovs-vsctl --no-wait set Open_vSwitch . other_config:dpdk-extra="-w ${PCINUM},representor=[0,1] --log-level=mlx5,8 --log-level=lib.eal:debug "
# ovs-vsctl --no-wait set Open_vSwitch . other_config:dpdk-extra="-w ${PCINUM},representor=pf0vf[0] -w ${PCINUM},representor=pf0vf[1] --log-level=mlx5,8 --log-level=lib.eal:debug "
# ovs-vsctl --no-wait set Open_vSwitch . other_config:dpdk-hugepage-dir=/hugepages
# ovs-vsctl --no-wait set Open_vSwitch . other_config:pmd-cpu-mask=0xF0
ovs-vsctl --no-wait set Open_vSwitch . other_config:dpdk-socket-mem=1024,1024
# ovs-vsctl --no-wait set Open_vSwitch . other_config:dpdk-lcore-mask=0x4

systemctl restart openvswitch

# ovs-vsctl --no-wait add-br br0-ovs -- set bridge br0-ovs datapath_type=netdev
# ovs-vsctl add-port br0-ovs pf0 -- set Interface pf0 type=dpdk options:dpdk-devargs=${PCINUM}
# ovs-vsctl add-port br0-ovs pf0vf0 -- set Interface pf0vf0 type=dpdk options:dpdk-devargs=${PCINUM},representor=[0]
# ovs-vsctl add-port br0-ovs pf0vf1 -- set Interface pf0vf1 type=dpdk options:dpdk-devargs=${PCINUM},representor=[1]
# ovs-vsctl add-port br0-ovs vdpa0 -- set Interface vdpa0 type=dpdkvdpa options:vdpa-socket-path=/var/run/virtio-forwarder/sock0 options:vdpa-accelerator-devargs=${PCINUM%%.*}.2 options:dpdk-devargs=${PCINUM},representor=[0] options:vdpa-max-queues=8

# systemctl restart openvswitch

EOF

# for 103
export IFNAME=enp4s0f0
export PCINUM=0000:04:00.0
export VF1MAC=e4:11:22:33:44:50
export VF2MAC=e4:11:22:33:44:51

# modprobe vfio-pci
# dpdk-devbind.py -b vfio-pci ${PCINUM%%.*}.2
# dpdk-devbind.py -b vfio-pci ${PCINUM%%.*}.3

bash /data/ovs-dpdk-env.sh

# for 105
export IFNAME=enp67s0f0
export PCINUM=0000:43:00.0
export VF1MAC=e4:11:22:33:55:60
export VF2MAC=e4:11:22:33:55:61

# modprobe vfio-pci
# dpdk-devbind.py -b vfio-pci ${PCINUM%%.*}.2
# dpdk-devbind.py -b vfio-pci ${PCINUM%%.*}.3

bash /data/ovs-dpdk-env.sh

/data/soft/dpdk-stable-20.11.3/examples/vdpa/build/vdpa -a ${PCINUM},class=vdpa --log-level=pmd,info -- -i
create /tmp/sock-virtio0 0000:43:00.2

/data/soft/dpdk-stable-20.11.3/examples/vdpa/build/vdpa -c 0x2 -n 4 --socket-mem 1024,1024 -a ${PCINUM%%.*}.2,vdpa=1 --log-level=pmd,info -- -i

/data/soft/dpdk-stable-20.11.3/examples/vdpa/build/vdpa -w ${PCINUM%%.*}.2,class=vdpa --log-level=pmd,info -- -i
create /tmp/sock-virtio0 0000:43:00.2

```

## kvm

```bash
sed -i.bak 's/#user = "root"/user = "root"/' /etc/libvirt/qemu.conf


export DOMAIN=cx6

virt-install --name="${DOMAIN}" --vcpus=2 --ram=8192 \
--cpu=host-model \
--disk path=/data/kvm/${DOMAIN}.qcow2,bus=virtio,size=30 \
--os-variant rhel8.4 \
--network type=direct,source=eno1,source_mode=bridge,model=virtio \
--graphics vnc,port=59000 \
--boot menu=on --location /data/kvm/Rocky-8.4-x86_64-minimal.iso \
--initrd-inject helper-ks-rocky.cfg --extra-args "inst.ks=file:/helper-ks-rocky.cfg" 

# https://doc.dpdk.org/guides/sample_app_ug/vdpa.html
# qemu-system-x86_64 -cpu host -enable-kvm \
# <snip>
# -mem-prealloc \
# -chardev socket,id=char0,path=<socket_file created in above steps> \
# -netdev type=vhost-user,id=vdpa,chardev=char0 \
# -device virtio-net-pci,netdev=vdpa,mac=00:aa:bb:cc:dd:ee,page-per-vq=on \

# --cpu host-model,numa.cell0.id=0,numa.cell0.cpus=0-1,numa.cell0.memory=8388608 \


mkdir -p /data/kvm
cat << 'EOF' > /data/kvm/bridge.sh
#!/usr/bin/env bash

PUB_CONN='eno1'
PUB_IP='172.21.6.105/24'
PUB_GW='172.21.6.254'
PUB_DNS='172.21.1.1'

nmcli con down "$PUB_CONN"
nmcli con delete "$PUB_CONN"
nmcli con down baremetal
nmcli con delete baremetal
# RHEL 8.1 appends the word "System" in front of the connection,delete in case it exists
nmcli con down "System $PUB_CONN"
nmcli con delete "System $PUB_CONN"
nmcli connection add ifname baremetal type bridge con-name baremetal ipv4.method 'manual' \
    ipv4.address "$PUB_IP" \
    ipv4.gateway "$PUB_GW" \
    ipv4.dns "$PUB_DNS"
    
nmcli con add type bridge-slave ifname "$PUB_CONN" master baremetal
nmcli con down "$PUB_CONN";pkill dhclient;dhclient baremetal
nmcli con up baremetal
EOF
bash /data/kvm/bridge.sh


/usr/libexec/qemu-kvm --machine ?
# Supported machines are:
# pc                   RHEL 7.6.0 PC (i440FX + PIIX, 1996) (alias of pc-i440fx-rhel7.6.0)
# pc-i440fx-rhel7.6.0  RHEL 7.6.0 PC (i440FX + PIIX, 1996) (default)
# pc-i440fx-rhel7.5.0  RHEL 7.5.0 PC (i440FX + PIIX, 1996)
# pc-i440fx-rhel7.4.0  RHEL 7.4.0 PC (i440FX + PIIX, 1996)
# pc-i440fx-rhel7.3.0  RHEL 7.3.0 PC (i440FX + PIIX, 1996)
# pc-i440fx-rhel7.2.0  RHEL 7.2.0 PC (i440FX + PIIX, 1996)
# pc-i440fx-rhel7.1.0  RHEL 7.1.0 PC (i440FX + PIIX, 1996)
# pc-i440fx-rhel7.0.0  RHEL 7.0.0 PC (i440FX + PIIX, 1996)
# q35                  RHEL-8.2.0 PC (Q35 + ICH9, 2009) (alias of pc-q35-rhel8.2.0)
# pc-q35-rhel8.2.0     RHEL-8.2.0 PC (Q35 + ICH9, 2009)
# pc-q35-rhel8.1.0     RHEL-8.1.0 PC (Q35 + ICH9, 2009)
# pc-q35-rhel8.0.0     RHEL-8.0.0 PC (Q35 + ICH9, 2009)
# pc-q35-rhel7.6.0     RHEL-7.6.0 PC (Q35 + ICH9, 2009)
# pc-q35-rhel7.5.0     RHEL-7.5.0 PC (Q35 + ICH9, 2009)
# pc-q35-rhel7.4.0     RHEL-7.4.0 PC (Q35 + ICH9, 2009)
# pc-q35-rhel7.3.0     RHEL-7.3.0 PC (Q35 + ICH9, 2009)
# none                 empty machine

cd /data/kvm
export DOMAIN=cx6.1

virt-install --name="${DOMAIN}" --vcpus=2 --ram=8192 \
--cputune vcpupin0.vcpu=14,vcpupin1.vcpu=16 \
--memorybacking hugepages.page0.size=1,hugepages.page0.unit=GiB \
--cpu host-model \
--disk path=/data/kvm/${DOMAIN}.qcow2,bus=virtio,size=30 \
--os-variant rhel8.4 \
--network bridge=baremetal,model=virtio \
--graphics vnc,port=59000 \
--boot menu=on --location /data/kvm/Rocky-8.4-x86_64-minimal.iso \
--initrd-inject helper-ks-rocky.cfg --extra-args "inst.ks=file:/helper-ks-rocky.cfg" 

virsh
qemu-monitor-command --domain cx6.1 --hmp  "info qtree"
# bus: main-system-bus
#   type System
#   dev: kvm-ioapic, id ""
#     gpio-in "" 24
#     gsi_base = 0 (0x0)
#     mmio 00000000fec00000/0000000000001000
#   dev: q35-pcihost, id ""
#     MCFG = 2952790016 (0xb0000000)
#     pci-hole64-size = 34359738368 (32 GiB)
#     short_root_bus = 0 (0x0)
#     below-4g-mem-size = 2147483648 (2 GiB)
#     above-4g-mem-size = 6442450944 (6 GiB)
#     x-pci-hole64-fix = true
#     bus: pcie.0
#       type PCIE
#       dev: qxl-vga, id "video0"
# ......

#    \
# --dry-run \
# --print-xml 1 > cx6.1.xml

# sed -i 's/memory="8388608"/& unit="KiB" memAccess="shared"/' cx6.1.xml

# virsh define --file cx6.1.xml

# ls /var/lib/libvirt/boot


# https://unix.stackexchange.com/questions/235414/libvirt-how-to-pass-qemu-command-line-args
# virt-xml $DOMAIN --edit --confirm --qemu-commandline 'env=MY-ENV=1234'
virt-xml $DOMAIN --edit --qemu-commandline='-chardev socket,id=charnet1,path=/tmp/sock-virtio0'
virt-xml $DOMAIN --edit --qemu-commandline='-netdev vhost-user,chardev=charnet1,queues=16,id=hostnet1'
virt-xml $DOMAIN --edit --qemu-commandline='-device virtio-net-pci,mq=on,vectors=6,netdev=hostnet1,id=net1,mac=e4:11:c6:d3:45:f2,bus=pcie.0,addr=0x6,page-per-vq=on,rx_queue_size=1024,tx_queue_size=1024'
```

```xml

  <cputune>
    <vcpupin vcpu='0' cpuset='14'/>
    <vcpupin vcpu='1' cpuset='16'/>
  </cputune>

  <cpu mode='host-model' check='partial'>
    <numa>
      <cell id='0' cpus='0-1' memory='8388608' unit='KiB' memAccess='shared'/>
    </numa>
  </cpu>
  
```

```bash
virsh dumpxml cx6.1
```
```xml

<domain type='kvm' id='11' xmlns:qemu='http://libvirt.org/schemas/domain/qemu/1.0'>
  <name>cx6.1</name>
  <uuid>5cbb6f7c-7122-4fc4-9706-ff46aed3bf25</uuid>
  <metadata>
    <libosinfo:libosinfo xmlns:libosinfo="http://libosinfo.org/xmlns/libvirt/domain/1.0">
      <libosinfo:os id="http://redhat.com/rhel/8.4"/>
    </libosinfo:libosinfo>
  </metadata>
  <memory unit='KiB'>8388608</memory>
  <currentMemory unit='KiB'>8388608</currentMemory>
  <memoryBacking>
    <hugepages>
      <page size='1048576' unit='KiB'/>
    </hugepages>
  </memoryBacking>
  <vcpu placement='static'>2</vcpu>
  <cputune>
    <vcpupin vcpu='0' cpuset='14'/>
    <vcpupin vcpu='1' cpuset='16'/>
  </cputune>
  <resource>
    <partition>/machine</partition>
  </resource>
  <os>
    <type arch='x86_64' machine='pc-q35-rhel8.2.0'>hvm</type>
    <boot dev='hd'/>
    <bootmenu enable='yes'/>
  </os>
  <features>
    <acpi/>
    <apic/>
  </features>
  <cpu mode='custom' match='exact' check='full'>
    <model fallback='forbid'>IvyBridge-IBRS</model>
    <vendor>Intel</vendor>
    <feature policy='require' name='ss'/>
    <feature policy='require' name='vmx'/>
    <feature policy='require' name='pdcm'/>
    <feature policy='require' name='pcid'/>
    <feature policy='require' name='hypervisor'/>
    <feature policy='require' name='arat'/>
    <feature policy='require' name='tsc_adjust'/>
    <feature policy='require' name='umip'/>
    <feature policy='require' name='md-clear'/>
    <feature policy='require' name='stibp'/>
    <feature policy='require' name='arch-capabilities'/>
    <feature policy='require' name='ssbd'/>
    <feature policy='require' name='xsaveopt'/>
    <feature policy='require' name='pdpe1gb'/>
    <feature policy='require' name='ibpb'/>
    <feature policy='require' name='ibrs'/>
    <feature policy='require' name='amd-stibp'/>
    <feature policy='require' name='amd-ssbd'/>
    <feature policy='require' name='skip-l1dfl-vmentry'/>
    <feature policy='require' name='pschange-mc-no'/>
    <numa>
      <cell id='0' cpus='0-1' memory='8388608' unit='KiB' memAccess='shared'/>
    </numa>
  </cpu>
  <clock offset='utc'>
    <timer name='rtc' tickpolicy='catchup'/>
    <timer name='pit' tickpolicy='delay'/>
    <timer name='hpet' present='no'/>
  </clock>
  <on_poweroff>destroy</on_poweroff>
  <on_reboot>restart</on_reboot>
  <on_crash>destroy</on_crash>
  <pm>
    <suspend-to-mem enabled='no'/>
    <suspend-to-disk enabled='no'/>
  </pm>
  <devices>
    <emulator>/usr/libexec/qemu-kvm</emulator>
    <disk type='file' device='disk'>
      <driver name='qemu' type='qcow2'/>
      <source file='/data/kvm/cx6.1.qcow2' index='2'/>
      <backingStore/>
      <target dev='vda' bus='virtio'/>
      <alias name='virtio-disk0'/>
      <address type='pci' domain='0x0000' bus='0x04' slot='0x00' function='0x0'/>
    </disk>
    <disk type='file' device='cdrom'>
      <driver name='qemu'/>
      <target dev='sda' bus='sata'/>
      <readonly/>
      <alias name='sata0-0-0'/>
      <address type='drive' controller='0' bus='0' target='0' unit='0'/>
    </disk>
    <controller type='usb' index='0' model='qemu-xhci' ports='15'>
      <alias name='usb'/>
      <address type='pci' domain='0x0000' bus='0x02' slot='0x00' function='0x0'/>
    </controller>
    <controller type='sata' index='0'>
      <alias name='ide'/>
      <address type='pci' domain='0x0000' bus='0x00' slot='0x1f' function='0x2'/>
    </controller>
    <controller type='pci' index='0' model='pcie-root'>
      <alias name='pcie.0'/>
    </controller>
    <controller type='pci' index='1' model='pcie-root-port'>
      <model name='pcie-root-port'/>
      <target chassis='1' port='0x10'/>
      <alias name='pci.1'/>
      <address type='pci' domain='0x0000' bus='0x00' slot='0x02' function='0x0' multifunction='on'/>
    </controller>
    <controller type='pci' index='2' model='pcie-root-port'>
      <model name='pcie-root-port'/>
      <target chassis='2' port='0x11'/>
      <alias name='pci.2'/>
      <address type='pci' domain='0x0000' bus='0x00' slot='0x02' function='0x1'/>
    </controller>
    <controller type='pci' index='3' model='pcie-root-port'>
      <model name='pcie-root-port'/>
      <target chassis='3' port='0x12'/>
      <alias name='pci.3'/>
      <address type='pci' domain='0x0000' bus='0x00' slot='0x02' function='0x2'/>
    </controller>
    <controller type='pci' index='4' model='pcie-root-port'>
      <model name='pcie-root-port'/>
      <target chassis='4' port='0x13'/>
      <alias name='pci.4'/>
      <address type='pci' domain='0x0000' bus='0x00' slot='0x02' function='0x3'/>
    </controller>
    <controller type='pci' index='5' model='pcie-root-port'>
      <model name='pcie-root-port'/>
      <target chassis='5' port='0x14'/>
      <alias name='pci.5'/>
      <address type='pci' domain='0x0000' bus='0x00' slot='0x02' function='0x4'/>
    </controller>
    <controller type='pci' index='6' model='pcie-root-port'>
      <model name='pcie-root-port'/>
      <target chassis='6' port='0x15'/>
      <alias name='pci.6'/>
      <address type='pci' domain='0x0000' bus='0x00' slot='0x02' function='0x5'/>
    </controller>
    <controller type='pci' index='7' model='pcie-root-port'>
      <model name='pcie-root-port'/>
      <target chassis='7' port='0x16'/>
      <alias name='pci.7'/>
      <address type='pci' domain='0x0000' bus='0x00' slot='0x02' function='0x6'/>
    </controller>
    <controller type='virtio-serial' index='0'>
      <alias name='virtio-serial0'/>
      <address type='pci' domain='0x0000' bus='0x03' slot='0x00' function='0x0'/>
    </controller>
    <interface type='bridge'>
      <mac address='52:54:00:8d:b6:8e'/>
      <source bridge='baremetal'/>
      <target dev='vnet2'/>
      <model type='virtio'/>
      <alias name='net0'/>
      <address type='pci' domain='0x0000' bus='0x01' slot='0x00' function='0x0'/>
    </interface>
    <serial type='pty'>
      <source path='/dev/pts/6'/>
      <target type='isa-serial' port='0'>
        <model name='isa-serial'/>
      </target>
      <alias name='serial0'/>
    </serial>
    <console type='pty' tty='/dev/pts/6'>
      <source path='/dev/pts/6'/>
      <target type='serial' port='0'/>
      <alias name='serial0'/>
    </console>
    <channel type='unix'>
      <source mode='bind' path='/var/lib/libvirt/qemu/channel/target/domain-11-cx6.1/org.qemu.guest_agent.0'/>
      <target type='virtio' name='org.qemu.guest_agent.0' state='disconnected'/>
      <alias name='channel0'/>
      <address type='virtio-serial' controller='0' bus='0' port='1'/>
    </channel>
    <input type='tablet' bus='usb'>
      <alias name='input0'/>
      <address type='usb' bus='0' port='1'/>
    </input>
    <input type='mouse' bus='ps2'>
      <alias name='input1'/>
    </input>
    <input type='keyboard' bus='ps2'>
      <alias name='input2'/>
    </input>
    <graphics type='vnc' port='59000' autoport='no' listen='127.0.0.1'>
      <listen type='address' address='127.0.0.1'/>
    </graphics>
    <video>
      <model type='qxl' ram='65536' vram='65536' vgamem='16384' heads='1' primary='yes'/>
      <alias name='video0'/>
      <address type='pci' domain='0x0000' bus='0x00' slot='0x01' function='0x0'/>
    </video>
    <memballoon model='virtio'>
      <stats period='5'/>
      <alias name='balloon0'/>
      <address type='pci' domain='0x0000' bus='0x05' slot='0x00' function='0x0'/>
    </memballoon>
    <rng model='virtio'>
      <backend model='random'>/dev/urandom</backend>
      <alias name='rng0'/>
      <address type='pci' domain='0x0000' bus='0x06' slot='0x00' function='0x0'/>
    </rng>
  </devices>
  <seclabel type='dynamic' model='selinux' relabel='yes'>
    <label>system_u:system_r:svirt_t:s0:c46,c926</label>
    <imagelabel>system_u:object_r:svirt_image_t:s0:c46,c926</imagelabel>
  </seclabel>
  <seclabel type='dynamic' model='dac' relabel='yes'>
    <label>+0:+0</label>
    <imagelabel>+0:+0</imagelabel>
  </seclabel>
  <qemu:commandline>
    <qemu:arg value='-chardev'/>
    <qemu:arg value='socket,id=charnet1,path=/tmp/sock-virtio0'/>
    <qemu:arg value='-netdev'/>
    <qemu:arg value='vhost-user,chardev=charnet1,queues=16,id=hostnet1'/>
    <qemu:arg value='-device'/>
    <qemu:arg value='virtio-net-pci,mq=on,vectors=6,netdev=hostnet1,id=net1,mac=e4:11:c6:d3:45:f2,bus=pcie.0,addr=0x6,page-per-vq=on,rx_queue_size=1024,tx_queue_size=1024'/>
  </qemu:commandline>
</domain>

```

```bash

ip addr add 192.168.55.41/24 dev enp0s6

```
```
VHOST_CONFIG: set queue enable: 0 to qp idx: 31
VHOST_CONFIG: read message VHOST_USER_SET_FEATURES
VHOST_CONFIG: negotiated Virtio features: 0x140601803
VHOST_CONFIG: read message VHOST_USER_SET_MEM_TABLE
VHOST_CONFIG: guest memory region 0, size: 0x80000000
         guest physical addr: 0x0
         guest virtual  addr: 0x7f6c00000000
         host  virtual  addr: 0x7f4640000000
         mmap addr : 0x7f4640000000
         mmap size : 0x80000000
         mmap align: 0x40000000
         mmap off  : 0x0
VHOST_CONFIG: guest memory region 1, size: 0x180000000
         guest physical addr: 0x100000000
         guest virtual  addr: 0x7f6c80000000
         host  virtual  addr: 0x7f44c0000000
         mmap addr : 0x7f4440000000
         mmap size : 0x200000000
         mmap align: 0x40000000
         mmap off  : 0x80000000
VHOST_CONFIG: read message VHOST_USER_SET_VRING_NUM
VHOST_CONFIG: read message VHOST_USER_SET_VRING_BASE
VHOST_CONFIG: read message VHOST_USER_SET_VRING_ADDR
VHOST_CONFIG: reallocate vq from 0 to 1 node
VHOST_CONFIG: reallocate dev from 0 to 1 node
VHOST_CONFIG: read message VHOST_USER_SET_VRING_KICK
VHOST_CONFIG: vring kick idx:0 file:153
mlx5_vdpa: Update virtq 0 status disable -> enable.

VHOST_CONFIG: reallocate vq from 0 to 1 node
VHOST_CONFIG: reallocate dev from 0 to 1 node
VHOST_CONFIG: read message VHOST_USER_SET_VRING_KICK
VHOST_CONFIG: vring kick idx:0 file:153
mlx5_vdpa: Update virtq 0 status disable -> enable.
VHOST_CONFIG: read message VHOST_USER_SET_VRING_CALL
VHOST_CONFIG: vring call idx:0 file:155
mlx5_vdpa: Update virtq 0 status enable -> disable.
mlx5_vdpa: Update virtq 0 status disable -> enable.
VHOST_CONFIG: read message VHOST_USER_SET_VRING_NUM
VHOST_CONFIG: read message VHOST_USER_SET_VRING_BASE
VHOST_CONFIG: read message VHOST_USER_SET_VRING_ADDR
VHOST_CONFIG: reallocate vq from 0 to 1 node
VHOST_CONFIG: read message VHOST_USER_SET_VRING_KICK
VHOST_CONFIG: vring kick idx:1 file:118
mlx5_vdpa: Update virtq 1 status disable -> enable.
VHOST_CONFIG: virtio is now ready for processing.

new port /tmp/sock-virtio0, device : 0000:43:00.2
mlx5_vdpa: MTU cannot be set on device 0000:43:00.2.
mlx5_vdpa: Region 0: HVA 0x7f4640000000, GPA 0x0, size 0x80000000.
mlx5_vdpa: Region 1: HVA 0x7f44c0000000, GPA 0x100000000, size 0x180000000.
mlx5_vdpa: Indirect mkey mode is KLM Fixed Buffer Size.
mlx5_vdpa: vid 0: Init last_avail_idx=0, last_used_idx=0 for virtq 0.
mlx5_vdpa: vid 0: Init last_avail_idx=0, last_used_idx=0 for virtq 1.
mlx5_vdpa: Virtq 0 notifier state is enabled.
mlx5_vdpa: Virtq 1 notifier state is enabled.
mlx5_vdpa: vDPA device 0 was configured.
VHOST_CONFIG: read message VHOST_USER_SET_VRING_CALL
VHOST_CONFIG: vring call idx:1 file:158
mlx5_vdpa: Update virtq 1 status enable -> disable.
mlx5_vdpa: Query vid 0 vring 1: hw_available_idx=0, hw_used_index=0
mlx5_vdpa: Update virtq 1 status disable -> enable.
mlx5_vdpa: vid 0: Init last_avail_idx=0, last_used_idx=0 for virtq 1.
VHOST_CONFIG: read message VHOST_USER_SET_VRING_ENABLE
VHOST_CONFIG: set queue enable: 1 to qp idx: 0
VHOST_CONFIG: read message VHOST_USER_SET_VRING_ENABLE
VHOST_CONFIG: set queue enable: 1 to qp idx: 1
VHOST_CONFIG: read message VHOST_USER_SET_FEATURES

VHOST_CONFIG: read message VHOST_USER_SET_VRING_ENABLE
VHOST_CONFIG: set queue enable: 1 to qp idx: 2
mlx5_vdpa: Update virtq 2 status disable -> enable.
mlx5_vdpa: vid 0: Init last_avail_idx=0, last_used_idx=0 for virtq 2.
mlx5_vdpa: Virtq 2 notifier state is enabled.
VHOST_CONFIG: read message VHOST_USER_SET_VRING_ENABLE
VHOST_CONFIG: set queue enable: 1 to qp idx: 3
mlx5_vdpa: Update virtq 3 status disable -> enable.
mlx5_vdpa: vid 0: Init last_avail_idx=0, last_used_idx=0 for virtq 3.
VHOST_CONFIG: read message VHOST_USER_SET_VRING_ENABLE
VHOST_CONFIG: set queue enable: 0 to qp idx: 4


VHOST_CONFIG: read message VHOST_USER_SET_VRING_ENABLE
VHOST_CONFIG: set queue enable: 0 to qp idx: 31
mlx5_vdpa: Virtq 3 notifier state is enabled.

```