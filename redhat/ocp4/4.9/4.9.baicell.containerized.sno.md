# 应用容器化步骤

# 需求

- [x] license使用容器化的方式注入
- [x] service 用 host port + ocp router的方式暴露
- [x] 容器启动后，自动加载基站进程
- [ ] fpga driver使用容器化方式加载
- [ ] 基础镜像梳理
- [ ] helm方式部署
- [ ] helm operator

## 分析

前2个需求，可以做成一个，容器启动自动加载，用systemd，改一版镜像。最后面的那个加载fgpa driver的，单独做一个

# license, serivce, route

```bash
# license file 加载到config map中
oc create configmap license.for.baicell  \
    --from-file=license=./3496531EC238AD91DED6DBA5BD6B.lic

cat << EOF > /data/install/vbbu.yaml
---

apiVersion: "k8s.cni.cncf.io/v1"
kind: NetworkAttachmentDefinition
metadata:
  name: host-device-du
spec:
  config: '{
    "cniVersion": "0.3.0",
    "type": "host-device",
    "device": "xeth",
    "ipam": {
      "type": "host-local",
      "subnet": "192.168.160.0/24",
      "gateway": "192.168.160.254",
      "rangeStart": "192.168.160.1",
      "rangeEnd": "192.168.160.1"
    }
  }'


---

apiVersion: "k8s.cni.cncf.io/v1"
kind: NetworkAttachmentDefinition
metadata:
  name: host-device-du-ens
spec:
  config: '{
    "cniVersion": "0.3.0",
    "type": "host-device",
    "device": "enp103s0f0",
    "ipam": {
      "type": "host-local",
      "subnet": "192.168.12.0/24",
      "rangeStart": "192.168.12.105",
      "rangeEnd": "192.168.12.106"
    }
  }'



---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: du-deployment1
  labels:
    app: du-deployment1
spec:
  replicas: 1
  selector:
    matchLabels:
      app: du-pod1
  template:
    metadata:
      labels:
        app: du-pod1
      annotations:
        k8s.v1.cni.cncf.io/networks: '[
          { "name": "host-device-du-ens",
            "interface": "veth11" },
          { "name": "host-device-du",
            "interface": "xeth" }
          ]'
      cpu-load-balancing.crio.io: "true"
    spec:
      runtimeClassName: performance-wzh-performanceprofile
      containers:
      - name: du-container1
        image: "registry.ocp4.redhat.ren:5443/ocp4/du:v1-1623-wzh-01"
        imagePullPolicy: IfNotPresent
        tty: true
        stdin: true
        env:
          - name: duNetProviderDriver
            value: "host-netdevice"
        # command: ["/usr/sbin/init"]
        # - sleep
        # - infinity
        securityContext:
            privileged: true
            capabilities:
                add:
                - CAP_SYS_ADMIN
        volumeMounts:
          - mountPath: /hugepages
            name: hugepage
          - name: lib-modules
            mountPath: /lib/modules
          - name: src
            mountPath: /usr/src
          - name: dev
            mountPath: /dev
          - name: cache-volume
            mountPath: /dev/shm
          - name: license-volume
            mountPath: /baicell/lic
        resources:
          requests:
            cpu: 14
            memory: 64Gi
            hugepages-1Gi: 16Gi
          limits:
            cpu: 14
            memory: 64Gi
            hugepages-1Gi: 16Gi
      volumes:
        - name: hugepage
          emptyDir:
            medium: HugePages
        - name: lib-modules
          hostPath:
            path: /lib/modules
        - name: src
          hostPath:
            path: /usr/src
        - name: dev
          hostPath:
            path: "/dev"
        - name: cache-volume
          emptyDir:
            medium: Memory
            sizeLimit: 16Gi
        - name: license-volume
          configMap:
            name: license.for.baicell
            items:
            - key: license
              path: license.lic
      nodeSelector:
        node-role.kubernetes.io/master: ""

---

apiVersion: v1
kind: Service
metadata:
  name: du-http 
spec:
  ports:
  - name: http
    port: 80
    targetPort: 80 
    nodePort: 31071
  type: NodePort 
  selector:
    app: du-pod1

---

apiVersion: route.openshift.io/v1
kind: Route
metadata:
  name: du-http 
spec:
  port:
    targetPort: 80
  to:
    kind: Service
    name: du-http 

---

EOF

oc create -f /data/install/vbbu.yaml

# to restore
oc delete -f /data/install/vbbu.yaml

# open browser, to access vbbu console
# http://du-http-default.apps.ocp4s.redhat.ren/

# license file locates in /baicell/lic/license.lic

```

## host path

```bash

# 创建host path
cat << EOF > /data/install/host-path.yaml
---
apiVersion: machineconfiguration.openshift.io/v1
kind: MachineConfig
metadata:
  name: 50-set-selinux-for-hostpath-baicell-master
  labels:
    machineconfiguration.openshift.io/role: master
spec:
  config:
    ignition:
      version: 2.2.0
    systemd:
      units:
        - contents: |
            [Unit]
            Description=Set SELinux chcon for hostpath baicell
            Before=kubelet.service

            [Service]
            Type=oneshot
            RemainAfterExit=yes
            ExecStartPre=-mkdir -p /var/baicell
            ExecStart=/usr/bin/chcon -Rt container_file_t /var/baicell

            [Install]
            WantedBy=multi-user.target
          enabled: true
          name: hostpath-baicell.service
EOF
oc create -f /data/install/host-path.yaml

# restore
oc delete -f /data/install/host-path.yaml

cat << EOF > /data/install/vbbu.yaml
---

apiVersion: "k8s.cni.cncf.io/v1"
kind: NetworkAttachmentDefinition
metadata:
  name: host-device-du
spec:
  config: '{
    "cniVersion": "0.3.0",
    "type": "host-device",
    "device": "xeth",
    "ipam": {
      "type": "host-local",
      "subnet": "192.168.160.0/24",
      "gateway": "192.168.160.254",
      "rangeStart": "192.168.160.1",
      "rangeEnd": "192.168.160.1"
    }
  }'


---

apiVersion: "k8s.cni.cncf.io/v1"
kind: NetworkAttachmentDefinition
metadata:
  name: host-device-du-ens
spec:
  config: '{
    "cniVersion": "0.3.0",
    "type": "host-device",
    "device": "enp103s0f0",
    "ipam": {
      "type": "host-local",
      "subnet": "192.168.12.0/24",
      "rangeStart": "192.168.12.105",
      "rangeEnd": "192.168.12.106"
    }
  }'



---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: du-deployment1
  labels:
    app: du-deployment1
spec:
  replicas: 1
  selector:
    matchLabels:
      app: du-pod1
  template:
    metadata:
      labels:
        app: du-pod1
      annotations:
        k8s.v1.cni.cncf.io/networks: '[
          { "name": "host-device-du-ens",
            "interface": "veth11" },
          { "name": "host-device-du",
            "interface": "xeth" }
          ]'
      cpu-load-balancing.crio.io: "true"
    spec:
      runtimeClassName: performance-wzh-performanceprofile
      containers:
      - name: du-container1
        image: "registry.ocp4.redhat.ren:5443/ocp4/du:v1-1623-wzh-01"
        imagePullPolicy: IfNotPresent
        tty: true
        stdin: true
        env:
          - name: duNetProviderDriver
            value: "host-netdevice"
        # command: ["/usr/sbin/init"]
        # - sleep
        # - infinity
        securityContext:
            privileged: true
            capabilities:
                add:
                - CAP_SYS_ADMIN
        volumeMounts:
          - mountPath: /hugepages
            name: hugepage
          - name: lib-modules
            mountPath: /lib/modules
          - name: src
            mountPath: /usr/src
          - name: dev
            mountPath: /dev
          - name: cache-volume
            mountPath: /dev/shm
          # - name: license-volume
          #   mountPath: /baicell/lic
          - name: config
            mountPath: /baicell
        resources:
          requests:
            cpu: 14
            memory: 64Gi
            hugepages-1Gi: 16Gi
          limits:
            cpu: 14
            memory: 64Gi
            hugepages-1Gi: 16Gi
      volumes:
        - name: hugepage
          emptyDir:
            medium: HugePages
        - name: lib-modules
          hostPath:
            path: /lib/modules
        - name: src
          hostPath:
            path: /usr/src
        - name: config
          hostPath:
            path: /var/baicell
        - name: dev
          hostPath:
            path: "/dev"
        - name: cache-volume
          emptyDir:
            medium: Memory
            sizeLimit: 16Gi
        # - name: license-volume
        #   configMap:
        #     name: license.for.baicell
        #     items:
        #     - key: license
        #       path: license.lic
      nodeSelector:
        node-role.kubernetes.io/master: ""

---

apiVersion: v1
kind: Service
metadata:
  name: du-http 
spec:
  ports:
  - name: http
    port: 80
    targetPort: 80 
    nodePort: 31071
  type: NodePort 
  selector:
    app: du-pod1

---

apiVersion: route.openshift.io/v1
kind: Route
metadata:
  name: du-http 
spec:
  port:
    targetPort: 80
  to:
    kind: Service
    name: du-http 

---

EOF

oc create -f /data/install/vbbu.yaml

# to restore
oc delete -f /data/install/vbbu.yaml

```

# 自动加载程序

/home/BaiBBU_XSS/tools/BBU start

## poc demo

```bash
mkdir -p /data/systemd

cd /data/systemd
cat << EOF > service.sh
#!/bin/bash

tail -f /dev/null &

EOF
cat << EOF > vbbu.service
[Unit]
Description=vBBU Server
After=network.target

[Service]
Type=forking
User=root
# WorkingDirectory=/home/BaiBBU_XSS/tools/
# ExecStart=/home/BaiBBU_XSS/tools/BBU start
WorkingDirectory=/root/
ExecStart=/service.sh

[Install]
WantedBy=multi-user.target
EOF

cat << EOF > ./vbbu.dockerfile
FROM docker.io/rockylinux/rockylinux:8

USER root
COPY service.sh /service.sh
RUN chmod +x /service.sh
COPY vbbu.service /etc/systemd/system/vbbu.service

RUN systemctl enable vbbu.service

entrypoint ["/usr/sbin/init"]
EOF

buildah bud -t quay.io/wangzheng422/qimgs:systemd -f vbbu.dockerfile .

podman run --rm -it quay.io/wangzheng422/qimgs:systemd

```

## for baicell

```bash

mkdir -p /data/wzh/systemd

cd /data/wzh/systemd
cat << EOF > vbbu.service
[Unit]
Description=vBBU Server
After=network.target

[Service]
Type=forking
User=root
WorkingDirectory=/home/BaiBBU_XSS/tools/
ExecStart=/home/BaiBBU_XSS/tools/BBU start

[Install]
WantedBy=multi-user.target
EOF

cat << EOF > ./vbbu.dockerfile
FROM registry.ocp4.redhat.ren:5443/ocp4/du:v1-1623

USER root
COPY vbbu.service /etc/systemd/system/vbbu.service
RUN systemctl enable vbbu.service

entrypoint ["/usr/sbin/init"]
EOF

buildah bud -t registry.ocp4.redhat.ren:5443/ocp4/du:v1-1623-wzh-01 -f vbbu.dockerfile .
buildah push registry.ocp4.redhat.ren:5443/ocp4/du:v1-1623-wzh-01

```

# fpga driver

- https://stackoverflow.com/questions/55291850/kubernetes-how-to-copy-a-cfg-file-into-container-before-contaner-running
- https://access.redhat.com/solutions/4929021

```bash

mkdir -p /data/wzh/fpga
cd /data/wzh/fpga

cat << EOF > ./ocp4.install.sh
#!/bin/bash

echo Creating Device Node
if ! [ -e /dev/nr_cdev0 ]
then
    mknod /dev/nr_cdev0 c 200 0
fi
if ! [ -e /dev/nr_cdev1 ]
then
    mknod /dev/nr_cdev1 c 201 0
fi
if ! [ -d /etc/nr ]
then
    mkdir /etc/nr
fi

if  lsmod  |grep nr_drv > /dev/null 2>&1
then
    echo NR Driver Module had loaded!
else
    echo Inserting NR Driver Module
    rmmod nr_drv > /dev/null 2>&1

    if [ $(uname -r) == "4.18.45-rt8-yocto-preempt-rt" ];
    then
        echo insmod nr_drv_wr.ko ...
        insmod nr_drv_wr.ko load_xeth=1
    elif [ $(uname -r) == "3.10.0-1127.rt56.1093.el7.x86_64" ];
    then
        echo insmod nr_drv_centos_1127.ko ...
        insmod nr_drv_centos_1127.ko load_xeth=1
    elif [ $(uname -r) == "3.10.0-693.2.2.rt56.623.el7.x86_64" ];
    then
        echo insmod nr_drv_centos_693.ko ...
        insmod nr_drv_centos_693.ko load_xeth=1
    else
        echo insmod nr_drv_ko Failed!
    fi
fi
EOF

cat << EOF > ./fpga.dockerfile
FROM docker.io/busybox:1.34

USER root
COPY BaiBBU_DXSS_1.0.18--4.18.0-305.19.1.PKG /BaiBBU_DXSS_1.0.18--4.18.0-305.19.1.PKG
COPY BaiBBU_DXSS_1.0.16--4.18.0-305.19.1.PKG /BaiBBU_DXSS_1.0.16--4.18.0-305.19.1.PKG

WORKDIR /
EOF

buildah bud -t registry.ocp4.redhat.ren:5443/baicell/fgpa-driver:v01 -f fpga.dockerfile .
buildah push registry.ocp4.redhat.ren:5443/baicell/fgpa-driver:v01

cat << EOF > /data/install/fpga.driver.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: fpga-driver
  # namespace: default
  labels:
    app: fpga-driver
spec:
  replicas: 1
  selector:
    matchLabels:
      app: fpga-driver
  template:
    metadata:
      labels:
        app: fpga-driver
    spec:
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchExpressions:
                  - key: "app"
                    operator: In
                    values:
                    - fpga-driver
              topologyKey: "kubernetes.io/hostname"
      nodeselector:
        node-role.kubernetes.io/master: ""
      # restartPolicy: Never
      initContainers:
      - name: copy
        image: registry.ocp4.redhat.ren:5443/baicell/fgpa-driver:v01
        command: ["/bin/sh", "-c", "tar zvxf /BaiBBU_DXSS_1.0.18--4.18.0-305.19.1.PKG --strip 1 -C /baicell/driver/ "]
        securityContext:
          privileged: true
          runAsUser: 0
        volumeMounts:
        - name: driver-files
          mountPath: /baicell/driver/
        - name: host
          mountPath: /host
      containers:
      - name: driver
        image: registry.redhat.io/rhel8/support-tools:8.4
        # imagePullPolicy: Always
        command: [ "/usr/bin/bash","-c","cd /baicell/driver/ || bash ./install.sh || tail -f /dev/null || true " ]
        # command: [ "/usr/bin/bash","-c","tail -f /dev/null || true " ]
        resources:
          requests:
            cpu: 100m
            memory: 200Mi
        securityContext:
          privileged: true
          runAsUser: 0
          capabilities:
            add:
              - IPC_LOCK
        volumeMounts:
        - name: driver-files
          mountPath: /baicell/driver/
        - name: host
          mountPath: /host
      volumes: 
      - name: driver-files
        emptyDir: {}
      - name: host
        hostPath:
          path: /
          type: Directory
EOF
oc create -f /data/install/fpga.driver.yaml

# to restore
oc delete -f /data/install/fpga.driver.yaml


```